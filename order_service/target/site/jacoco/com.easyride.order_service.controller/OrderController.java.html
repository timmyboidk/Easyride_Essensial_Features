<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">order_service</a> &gt; <a href="index.source.html" class="el_package">com.easyride.order_service.controller</a> &gt; <span class="el_source">OrderController.java</span></div><h1>OrderController.java</h1><pre class="source lang-java linenums">package com.easyride.order_service.controller;

import com.easyride.order_service.dto.*; // Ensure ApiResponse is here
import com.easyride.order_service.model.OrderStatus;
import com.easyride.order_service.security.OrderDetailsImpl;
import com.easyride.order_service.service.OrderService;
import jakarta.validation.Valid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping(&quot;/orders&quot;)
public class OrderController {

<span class="nc" id="L18">    private static final Logger log = LoggerFactory.getLogger(OrderController.class);</span>
    private final OrderService orderService;

<span class="nc" id="L21">    public OrderController(OrderService orderService) {</span>
<span class="nc" id="L22">        this.orderService = orderService;</span>
<span class="nc" id="L23">    }</span>

    @PostMapping(&quot;/create&quot;)
    public ApiResponse&lt;OrderResponseDto&gt; createOrder(@Valid @RequestBody OrderCreateDto orderCreateDto) {
        // Assuming passengerId comes from authenticated principal or is validated if passed in DTO
        // For simplicity, if passengerId is in DTO, ensure it matches authenticated user or requires specific role.
        // Long passengerId = getAuthenticatedPassengerId();
        // orderCreateDto.setPassengerId(passengerId); // Set it if not already part of DTO or override
<span class="nc" id="L31">        log.info(&quot;Received request to create order: {}&quot;, orderCreateDto);</span>
<span class="nc" id="L32">        OrderResponseDto responseDto = orderService.createOrder(orderCreateDto);</span>
<span class="nc" id="L33">        log.info(&quot;Order created successfully with ID: {}&quot;, responseDto.getOrderId());</span>
<span class="nc" id="L34">        return ApiResponse.success(&quot;订单创建请求已提交，等待匹配司机&quot;, responseDto);</span>
    }

    @PostMapping(&quot;/{orderId}/accept&quot;)
    public ApiResponse&lt;String&gt; acceptOrder(@PathVariable Long orderId, @RequestParam Long driverId) {
        // This endpoint might be called by MatchingService internally or an Admin.
        // If called by driver, driverId should come from authenticated principal.
<span class="nc" id="L41">        log.info(&quot;Driver {} attempting to accept order {}&quot;, driverId, orderId);</span>
<span class="nc" id="L42">        orderService.acceptOrder(orderId, driverId); // This logic will change based on prompt 3</span>
<span class="nc" id="L43">        log.info(&quot;Order {} accepted by driver {}&quot;, orderId, driverId);</span>
<span class="nc" id="L44">        return ApiResponse.successMessage(&quot;订单已接单&quot;);</span>
    }

    @GetMapping(&quot;/{orderId}&quot;)
    public ApiResponse&lt;OrderResponseDto&gt; getOrderDetails(@PathVariable Long orderId) {
<span class="nc" id="L49">        log.info(&quot;Fetching details for order ID: {}&quot;, orderId);</span>
<span class="nc" id="L50">        OrderResponseDto responseDto = orderService.getOrderDetails(orderId);</span>
<span class="nc" id="L51">        return ApiResponse.success(responseDto);</span>
    }

    @PostMapping(&quot;/{orderId}/cancel&quot;)
    public ApiResponse&lt;String&gt; cancelOrder(@PathVariable Long orderId) {
        // Logic to determine who is cancelling and if allowed (e.g. passengerId from principal)
        // Long cancellingUserId = getAuthenticatedUserId();
<span class="nc" id="L58">        log.info(&quot;User attempting to cancel order ID: {}&quot;, orderId);</span>
<span class="nc" id="L59">        orderService.cancelOrder(orderId /*, cancellingUserId, userRole */);</span>
<span class="nc" id="L60">        log.info(&quot;Order ID: {} cancelled successfully.&quot;, orderId);</span>
<span class="nc" id="L61">        return ApiResponse.successMessage(&quot;订单已取消&quot;);</span>
    }

    @PostMapping(&quot;/{orderId}/status&quot;)
    public ApiResponse&lt;String&gt; updateOrderStatus(@PathVariable Long orderId, @RequestBody UpdateOrderStatusDto statusDto) {
        // Should be restricted, e.g., only driver can update to ARRIVED, IN_PROGRESS
        // Long principalId = getAuthenticatedUserId();
<span class="nc" id="L68">        log.info(&quot;Attempting to update status for order ID: {} to {}&quot;, orderId, statusDto.getStatus());</span>
<span class="nc" id="L69">        orderService.updateOrderStatus(orderId, statusDto.getStatus() /*, principalId, principalRole */);</span>
<span class="nc" id="L70">        log.info(&quot;Order ID: {} status updated to {}.&quot;, orderId, statusDto.getStatus());</span>
<span class="nc" id="L71">        return ApiResponse.successMessage(&quot;订单状态已更新&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>