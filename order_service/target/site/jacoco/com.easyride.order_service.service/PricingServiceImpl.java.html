<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PricingServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">order_service</a> &gt; <a href="index.source.html" class="el_package">com.easyride.order_service.service</a> &gt; <span class="el_source">PricingServiceImpl.java</span></div><h1>PricingServiceImpl.java</h1><pre class="source lang-java linenums">package com.easyride.order_service.service;

import com.easyride.order_service.dto.EstimatedPriceInfo;
import com.easyride.order_service.dto.FinalPriceInfo;
import com.easyride.order_service.dto.PricingContext;
import com.easyride.order_service.exception.PricingException;
import com.easyride.order_service.model.Order;
import com.easyride.order_service.model.OrderStatus;
import com.easyride.order_service.model.ServiceType;
import com.easyride.order_service.util.DistanceCalculator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.time.LocalDateTime;
import java.time.LocalTime;

//basic implemenation,subject to change in terms of business model
//inject PricingService into OrderServiceImpl and use it in createOrder and when calculating final cost.
@Service
<span class="fc" id="L22">public class PricingServiceImpl implements PricingService {</span>

<span class="fc" id="L24">    private static final Logger log = LoggerFactory.getLogger(PricingServiceImpl.class);</span>

    // Base rates (example, move to config or DB)
    private static final double BASE_FARE_NORMAL = 2.5; // USD
    private static final double PER_KM_RATE_NORMAL = 1.5;
    private static final double PER_MINUTE_RATE_NORMAL = 0.2;

    private static final double BASE_FARE_CARPOOL = 1.8;
    private static final double PER_KM_RATE_CARPOOL = 1.0;
    private static final double PER_MINUTE_RATE_CARPOOL = 0.15;

    private static final double AIRPORT_SURCHARGE = 5.0;
    private static final double CHARTER_HOURLY_RATE = 50.0;

    private static final double CANCELLATION_FEE_DRIVER_EN_ROUTE = 5.0; // Example fee
    private static final double CANCELLATION_FEE_ARRIVED = 8.0;
<span class="fc" id="L40">    private static final int FREE_CANCELLATION_WINDOW_MINUTES = 5; // After order acceptance</span>

    @Override
    public EstimatedPriceInfo calculateEstimatedPrice(PricingContext context) {
<span class="fc bfc" id="L44" title="All 2 branches covered.">        if (context.getStartLocation() == null</span>
<span class="pc bpc" id="L45" title="1 of 4 branches missed.">                || (context.getEndLocation() == null &amp;&amp; context.getServiceType() != ServiceType.CHARTER_HOURLY)) {</span>
<span class="fc" id="L46">            throw new PricingException(&quot;Start or end location missing for price estimation.&quot;);</span>
        }
<span class="fc" id="L48">        log.info(&quot;Calculating estimated price for context: {}&quot;, context);</span>

<span class="fc" id="L50">        double distanceKm = 0;</span>
<span class="fc" id="L51">        double durationMinutes = 5;</span>

<span class="fc bfc" id="L53" title="All 2 branches covered.">        if (context.getEndLocation() != null) {</span>
<span class="fc" id="L54">            distanceKm = DistanceCalculator.calculateDistance(</span>
<span class="fc" id="L55">                    context.getStartLocation().getLatitude(), context.getStartLocation().getLongitude(),</span>
<span class="fc" id="L56">                    context.getEndLocation().getLatitude(), context.getEndLocation().getLongitude());</span>

            // Simplified duration estimation (e.g., average speed of 30km/h)
<span class="fc" id="L59">            durationMinutes = (distanceKm / 30.0) * 60.0;</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">            if (distanceKm == 0)</span>
<span class="nc" id="L61">                durationMinutes = 5; // Min duration for very short trips</span>
        }

        double estimatedCost;
<span class="fc" id="L65">        double baseFare = BASE_FARE_NORMAL;</span>
<span class="fc" id="L66">        double perKmRate = PER_KM_RATE_NORMAL;</span>
<span class="fc" id="L67">        double perMinuteRate = PER_MINUTE_RATE_NORMAL;</span>

<span class="fc" id="L69">        StringBuilder breakdown = new StringBuilder();</span>

<span class="fc bfc" id="L71" title="All 4 branches covered.">        switch (context.getServiceType()) {</span>
            case CARPOOL:
<span class="fc" id="L73">                baseFare = BASE_FARE_CARPOOL;</span>
<span class="fc" id="L74">                perKmRate = PER_KM_RATE_CARPOOL;</span>
<span class="fc" id="L75">                perMinuteRate = PER_MINUTE_RATE_CARPOOL;</span>
<span class="fc" id="L76">                break;</span>
            case AIRPORT_TRANSFER:
<span class="fc" id="L78">                baseFare += AIRPORT_SURCHARGE;</span>
<span class="fc" id="L79">                break;</span>
            case CHARTER_HOURLY:
                // For charter, estimation might be different, e.g. min hours
<span class="pc bpc" id="L82" title="2 of 4 branches missed.">                if (context.getScheduledTime() != null &amp;&amp; context.getEndLocation() == null) { // Assuming charter</span>
                                                                                              // implies duration based
                    // Let's say user specifies hours, or we estimate a minimum
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">                    durationMinutes = context.getActualDurationMinutes() != null ? context.getActualDurationMinutes()</span>
<span class="nc" id="L86">                            : 60.0; // default 1 hour</span>
<span class="fc" id="L87">                    estimatedCost = CHARTER_HOURLY_RATE * (durationMinutes / 60.0);</span>
<span class="fc" id="L88">                    breakdown.append(String.format(&quot;Charter Hourly Rate: $%.2f/hr, Estimated Hours: %.2f&quot;,</span>
<span class="fc" id="L89">                            CHARTER_HOURLY_RATE, durationMinutes / 60.0));</span>
<span class="fc" id="L90">                    return EstimatedPriceInfo.builder()</span>
<span class="fc" id="L91">                            .estimatedCost(estimatedCost)</span>
<span class="fc" id="L92">                            .estimatedDistance(0) // Distance might not be primary factor</span>
<span class="fc" id="L93">                            .estimatedDuration(durationMinutes)</span>
<span class="fc" id="L94">                            .currency(&quot;USD&quot;)</span>
<span class="fc" id="L95">                            .priceBreakdown(breakdown.toString())</span>
<span class="fc" id="L96">                            .build();</span>
                } // else fall through to normal if start/end provided for some reason
                break;
            // Add cases for LONG_DISTANCE, EXPRESS, LUXURY with different
            // base/rates/multipliers
            default:
                // Use normal rates
                break;
        }

<span class="fc" id="L106">        estimatedCost = baseFare + (distanceKm * perKmRate) + (durationMinutes * perMinuteRate);</span>

        // Peak hour surcharge (example: 7-9 AM and 5-7 PM, 20% surcharge)
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (context.getScheduledTime() != null) {</span>
<span class="fc" id="L110">            LocalTime scheduledTime = context.getScheduledTime().toLocalTime();</span>
<span class="pc bpc" id="L111" title="1 of 4 branches missed.">            if ((scheduledTime.isAfter(LocalTime.of(7, 0)) &amp;&amp; scheduledTime.isBefore(LocalTime.of(9, 0))) ||</span>
<span class="pc bpc" id="L112" title="2 of 4 branches missed.">                    (scheduledTime.isAfter(LocalTime.of(17, 0)) &amp;&amp; scheduledTime.isBefore(LocalTime.of(19, 0)))) {</span>
<span class="fc" id="L113">                double surge = estimatedCost * 0.20;</span>
<span class="fc" id="L114">                estimatedCost += surge;</span>
<span class="fc" id="L115">                breakdown.append(String.format(</span>
<span class="fc" id="L116">                        &quot;Base: $%.2f, Distance (%.2fkm * $%.2f): $%.2f, Duration (%.2fmin * $%.2f): $%.2f, Peak Surge: $%.2f&quot;,</span>
<span class="fc" id="L117">                        baseFare, distanceKm, perKmRate, distanceKm * perKmRate, durationMinutes, perMinuteRate,</span>
<span class="fc" id="L118">                        durationMinutes * perMinuteRate, surge));</span>
<span class="fc" id="L119">            } else {</span>
<span class="nc" id="L120">                breakdown.append(String.format(</span>
<span class="nc" id="L121">                        &quot;Base: $%.2f, Distance (%.2fkm * $%.2f): $%.2f, Duration (%.2fmin * $%.2f): $%.2f&quot;,</span>
<span class="nc" id="L122">                        baseFare, distanceKm, perKmRate, distanceKm * perKmRate, durationMinutes, perMinuteRate,</span>
<span class="nc" id="L123">                        durationMinutes * perMinuteRate));</span>
            }
        }

<span class="fc" id="L127">        log.info(&quot;Estimated price: cost={}, distance={}, duration={}&quot;, estimatedCost, distanceKm, durationMinutes);</span>
<span class="fc" id="L128">        return EstimatedPriceInfo.builder()</span>
<span class="fc" id="L129">                .estimatedCost(Math.max(estimatedCost, baseFare)) // Ensure minimum is base fare</span>
<span class="fc" id="L130">                .estimatedDistance(distanceKm)</span>
<span class="fc" id="L131">                .estimatedDuration(durationMinutes)</span>
<span class="fc" id="L132">                .currency(&quot;USD&quot;) // Configurable</span>
<span class="fc" id="L133">                .priceBreakdown(breakdown.toString())</span>
<span class="fc" id="L134">                .build();</span>
    }

    @Override
    public FinalPriceInfo calculateFinalPrice(Order order, PricingContext finalPricingContext) { // Corrected signature
<span class="pc bpc" id="L139" title="1 of 4 branches missed.">        if (order.getDriverAssignedTime() == null || order.getOrderTime() == null) {</span>
<span class="fc" id="L140">            throw new PricingException(&quot;Cannot calculate final price without trip times.&quot;);</span>
        }

<span class="fc" id="L143">        LocalDateTime startTime = order.getDriverAssignedTime();</span>
<span class="fc" id="L144">        LocalDateTime endTime = order.getOrderTime();</span>
<span class="fc" id="L145">        long durationInMinutes = Duration.between(startTime, endTime).toMinutes();</span>

<span class="fc" id="L147">        double distance = DistanceCalculator.calculateDistance(</span>
<span class="fc" id="L148">                finalPricingContext.getStartLocation().getLatitude(),</span>
<span class="fc" id="L149">                finalPricingContext.getStartLocation().getLongitude(),</span>
<span class="fc" id="L150">                finalPricingContext.getEndLocation().getLatitude(),</span>
<span class="fc" id="L151">                finalPricingContext.getEndLocation().getLongitude());</span>

<span class="fc" id="L153">        long distanceCost = (long) (PER_KM_RATE_NORMAL * distance);</span>
<span class="fc" id="L154">        long timeCost = (long) (PER_MINUTE_RATE_NORMAL * durationInMinutes);</span>
<span class="fc" id="L155">        long finalPrice = (long) (BASE_FARE_NORMAL + distanceCost + timeCost);</span>

<span class="fc" id="L157">        FinalPriceInfo finalPriceInfo = new FinalPriceInfo();</span>
<span class="fc" id="L158">        finalPriceInfo.setFinalCost(finalPrice);</span>
<span class="fc" id="L159">        finalPriceInfo.setActualDistance(distance);</span>
<span class="fc" id="L160">        finalPriceInfo.setActualDuration(durationInMinutes);</span>
<span class="fc" id="L161">        finalPriceInfo.setBaseFare((long) BASE_FARE_NORMAL);</span>
<span class="fc" id="L162">        finalPriceInfo.setDistanceCost(distanceCost);</span>
<span class="fc" id="L163">        finalPriceInfo.setTimeCost(timeCost);</span>

<span class="fc" id="L165">        return finalPriceInfo;</span>
    }

    // Implement calculateCancellationFee
    @Override
    public double calculateCancellationFee(Order order, LocalDateTime cancellationTime) {
<span class="fc" id="L171">        log.info(&quot;Calculating cancellation fee for order ID: {}&quot;, order.getId());</span>
<span class="fc" id="L172">        double fee = 0.0;</span>

<span class="pc bpc" id="L174" title="1 of 4 branches missed.">        if (order.getStatus() == OrderStatus.SCHEDULED &amp;&amp; order.getScheduledTime() != null) {</span>
            // Rule for scheduled orders: e.g., free if cancelled &gt; 1 hour before scheduled
            // time
<span class="fc bfc" id="L177" title="All 2 branches covered.">            if (cancellationTime.isBefore(order.getScheduledTime().minusHours(1))) {</span>
<span class="fc" id="L178">                return 0.0;</span>
            } else {
<span class="fc" id="L180">                return BASE_FARE_NORMAL; // Example fixed fee for late scheduled cancellation</span>
            }
        }

        // Rules for on-demand orders after driver assigned/accepted
<span class="fc" id="L185">        LocalDateTime decisionPointTime = order.getDriverAssignedTime(); // Add this field to Order model</span>
<span class="pc bpc" id="L186" title="1 of 4 branches missed.">        if (order.getStatus() == OrderStatus.DRIVER_ASSIGNED || order.getStatus() == OrderStatus.ACCEPTED) {</span>
<span class="fc" id="L187">            decisionPointTime = order.getUpdatedAt(); // Time it was accepted/assigned</span>
<span class="pc bpc" id="L188" title="2 of 4 branches missed.">        } else if (order.getStatus() == OrderStatus.DRIVER_EN_ROUTE || order.getStatus() == OrderStatus.ARRIVED) {</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">            decisionPointTime = order.getDriverEnRouteTime() != null ? order.getDriverEnRouteTime()</span>
<span class="fc" id="L190">                    : order.getUpdatedAt(); // Add driverEnRouteTime</span>
        }

<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (decisionPointTime != null &amp;&amp; Duration.between(decisionPointTime, cancellationTime)</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">                .toMinutes() &gt; FREE_CANCELLATION_WINDOW_MINUTES) {</span>
<span class="pc bpc" id="L195" title="2 of 3 branches missed.">            switch (order.getStatus()) {</span>
                case DRIVER_ASSIGNED: // or ACCEPTED
                case DRIVER_EN_ROUTE:
<span class="nc" id="L198">                    fee = CANCELLATION_FEE_DRIVER_EN_ROUTE;</span>
<span class="nc" id="L199">                    log.info(&quot;Cancellation fee (driver en route) applied: ${}&quot;, fee);</span>
<span class="nc" id="L200">                    break;</span>
                case ARRIVED:
<span class="fc" id="L202">                    fee = CANCELLATION_FEE_ARRIVED;</span>
<span class="fc" id="L203">                    log.info(&quot;Cancellation fee (driver arrived) applied: ${}&quot;, fee);</span>
<span class="fc" id="L204">                    break;</span>
                default:
<span class="nc" id="L206">                    fee = 0.0; // No fee if cancelled before driver is well on their way or too early</span>
                    break;
            }
<span class="nc" id="L209">        } else {</span>
<span class="fc" id="L210">            log.info(&quot;Order {} cancelled within free window or in a non-chargeable state.&quot;, order.getId());</span>
        }
<span class="fc" id="L212">        return fee;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>